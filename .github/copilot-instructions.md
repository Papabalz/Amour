# Amour Codebase AI Agent Instructions

## Project Overview
**Amour** is a SvelteKit-based tourism booking platform that integrates user authentication, booking management, and payment processing. The app is multi-language enabled (EN/ES) and uses Drizzle ORM with PostgreSQL.

## Architecture & Data Flow

### Core Stack
- **Framework**: SvelteKit 2.x with Svelte 5
- **Database**: PostgreSQL via Drizzle ORM + migrations
- **Auth**: JWT-based sessions with secure HTTP-only cookies (30-day expiry)
- **Payments**: PesaPal integration for transaction processing
- **Email**: Nodemailer via Zoho SMTP with MJML templates
- **Internationalization**: Paraglide JS for EN/ES localization
- **Styling**: Tailwind CSS 4 + DaisyUI

### Key Data Model
Three core entities with cascading deletes:
- **User**: Stores credentials (bcrypt-hashed), profile data
- **Booking**: Tour bookings linked to user, includes payment status flag
- **Transaction**: PesaPal payment records linked to user and booking (1-to-1)

[Schema reference](src/lib/server/db/schema.ts) defines relations; Drizzle migrations in `drizzle/` folder.

### Request-Response Patterns
- **Server Actions**: Use SvelteKit's `+page.server.ts` `actions: Actions` pattern for form handling
- **Action Functions**: Defined in `src/lib/action/` (e.g., `createBooking()`, `loginUser()`), receive `{request}` and return `fail()` or success objects
- **Session Flow**: `hooks.server.ts` wraps every request—validates JWT, populates `event.locals.user`, re-fetches from DB to ensure freshness
- **Email Triggers**: Booking confirmation and welcome emails sent via `sendBookingConfirmation()` and `sendWelcomeEmail()` after DB writes

## Critical Developer Workflows

### Database Operations
```bash
npm run db:push       # Push schema changes to database
npm run db:migrate    # Apply pending migrations
npm run db:studio     # Launch Drizzle Studio GUI to inspect data
```
After modifying [schema.ts](src/lib/server/db/schema.ts), always run `db:push` to generate and apply migrations.

### Development & Build
```bash
npm run dev          # Start dev server (hot reload)
npm run check        # Type-check (svelte-check) without building
npm run check:watch  # Watch mode for type-checking
npm run build        # Production build
npm run format       # Format code with Prettier
npm run lint         # Check format compliance
```

### Auth & Session Management
- **Create Session**: `createSession(cookies, userPayload)` sets JWT token as secure cookie after signup/login
- **Destroy Session**: `destroySession(cookies)` on logout (see `src/routes/logout/+page.server.ts`)
- **Verify Session**: `getSession(cookies)` validates JWT; called in `hooks.server.ts` to populate `event.locals.user`

## Project-Specific Conventions

### File Organization
- **Routes**: `src/routes/` use SvelteKit file-based routing (`+page.svelte`, `+page.server.ts`)
- **Components**: Reusable UI in `src/components/` (Welcome, About, Reviews, TourGuideCard, TourSiteCard)
- **Actions**: Business logic in `src/lib/action/` separated by domain (booking.ts, user.ts, transaction.ts)
- **Database**: Connection & schema in `src/lib/server/db/`; session logic in `src/lib/server/session.ts`

### Error Handling
Use SvelteKit's `fail(statusCode, {message, success})` pattern for validation errors. Example:
```typescript
if (!email) return fail(400, { message: 'Email is required', success: false });
```

### Booking & Payment Flow
1. User fills booking form → `createBooking()` validates & inserts into DB
2. `sendBookingConfirmation()` emails confirmation details
3. User initiates payment via PesaPal (see `src/lib/pesapal.ts`)
4. Payment callback received, transaction record created with status
5. Booking's `isPaid` and `status` flags updated

### Multi-language Support
- Paraglide middleware in `hooks.server.ts` detects locale from request
- HTML placeholder `%paraglide.lang%` replaced with detected locale
- Message keys in `src/lib/paraglide/messages/` (en.js, es.js)
- Import as: `import { page } from '$app/stores'` then access `$page.locale`

## Integration Points & External Dependencies

### PesaPal Payment Service
- Configuration: `PESAPAL_CONSUMER_KEY`, `PESAPAL_CONSUMER_SECRET` env vars
- Sandbox/Live toggle via `environment` config in `src/lib/pesapal.ts`
- Creates token, initiates payment, handles callbacks at `/pesapal/callback`

### Email Service (Zoho SMTP)
- Credentials: `ZOHO_EMAIL`, `ZOHO_PASSWORD` env vars
- Templates in `src/lib/email/templates/` (MJML format)
- Current templates: booking-confirmation.mjml, welcome.mjml

### Database Connection
- `@neondatabase/serverless` for PostgreSQL (serverless-compatible)
- Drizzle ORM with query builder; see [db/index.ts](src/lib/server/db/index.ts) for connection setup

## Important Notes
- **Migrations**: Always generated by Drizzle after schema changes; stored in `drizzle/` with numbered files
- **Session Security**: Tokens are HTTP-only, Secure (prod), SameSite=Lax; re-fetching user ensures permissions are current
- **Type Safety**: Leverage TypeScript and Drizzle's `$inferSelect` for end-to-end type inference
- **Localization**: Paraglide middleware runs early; always ensure locale is available before rendering
